# This is a basic workflow to help you get started with Actions

name: CI

env:
  DISPLAY: ':99'

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
  workflow_dispatch:
  push:
    branches: [ master,  github-workflow-playground ]
  pull_request:
    branches: [ master ]
#  schedule:
#    - cron: "0 */12 * * *"

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  window-build:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        config:
          - {
            name: "Windows Latest MSVC",
            os: windows-2022,
            cc: "cl", cxx: "cl",
            environment_script: "C:/Program Files/Microsoft Visual Studio/2022/Enterprise/VC/Auxiliary/Build/vcvars64.bat",
          }

    steps:
      - uses: actions/checkout@v2
      - name: Checkout submodule repo
        uses: actions/checkout@v2
        with:
          repository: bluetiger9/SmtpClient-for-Qt
          path: "src/smtpclient/"
          ref: 3fa4a0fe5797070339422cf18b5e9ed8dcb91f9c

      - uses: actions/checkout@v2
      - name: Checkout submodule repo
        uses: actions/checkout@v2
        with:
          repository: cagnulein/qmdnsengine
          path: "src/qmdnsengine/"
          ref: "zwift"   

      - uses: actions/checkout@v2
      - name: Checkout submodule repo
        uses: actions/checkout@v2
        with:
          repository: google/googletest
          path: "tst/googletest/"
          ref: "release-1.12.1"

      - name: Download Ninja and CMake
        id: cmake_and_ninja
        shell: cmake -P {0}
        run: |
          set(cmake_version $ENV{CMAKE_VERSION})
          set(ninja_version $ENV{NINJA_VERSION})
          message(STATUS "Using host CMake version: ${CMAKE_VERSION}")
          if ("${{ runner.os }}" STREQUAL "Windows")
            set(ninja_suffix "win.zip")
            set(cmake_suffix "win64-x64.zip")
            set(cmake_dir "cmake-${cmake_version}-win64-x64/bin")
          elseif ("${{ runner.os }}" STREQUAL "Linux")
            set(ninja_suffix "linux.zip")
            set(cmake_suffix "Linux-x86_64.tar.gz")
            set(cmake_dir "cmake-${cmake_version}-Linux-x86_64/bin")
          elseif ("${{ runner.os }}" STREQUAL "macOS")
            set(ninja_suffix "mac.zip")
            set(cmake_suffix "Darwin-x86_64.tar.gz")
            set(cmake_dir "cmake-${cmake_version}-Darwin-x86_64/CMake.app/Contents/bin")
          endif()
          set(ninja_url "https://github.com/ninja-build/ninja/releases/download/v${ninja_version}/ninja-${ninja_suffix}")
          file(DOWNLOAD "${ninja_url}" ./ninja.zip SHOW_PROGRESS)
          execute_process(COMMAND ${CMAKE_COMMAND} -E tar xvf ./ninja.zip)
          set(cmake_url "https://github.com/Kitware/CMake/releases/download/v${cmake_version}/cmake-${cmake_version}-${cmake_suffix}")
          file(DOWNLOAD "${cmake_url}" ./cmake.zip SHOW_PROGRESS)
          execute_process(COMMAND ${CMAKE_COMMAND} -E tar xvf ./cmake.zip)
          # Save the path for other steps
          file(TO_CMAKE_PATH "$ENV{GITHUB_WORKSPACE}/${cmake_dir}" cmake_dir)
          message("::set-output name=cmake_dir::${cmake_dir}")
          if (NOT "${{ runner.os }}" STREQUAL "Windows")
            execute_process(
              COMMAND chmod +x ninja
              COMMAND chmod +x ${cmake_dir}/cmake
            )
          endif()

      - name: Configure
        shell: cmake -P {0}
        run: |
          set(ENV{CC} ${{ matrix.config.cc }})
          set(ENV{CXX} ${{ matrix.config.cxx }})
          if ("${{ runner.os }}" STREQUAL "Windows" AND NOT "x${{ matrix.config.environment_script }}" STREQUAL "x")
            execute_process(
              COMMAND "${{ matrix.config.environment_script }}" && set
              OUTPUT_FILE environment_script_output.txt
            )
            file(STRINGS environment_script_output.txt output_lines)
            foreach(line IN LISTS output_lines)
              if (line MATCHES "^([a-zA-Z0-9_-]+)=(.*)$")
                set(ENV{${CMAKE_MATCH_1}} "${CMAKE_MATCH_2}")
              endif()
            endforeach()
          endif()
          set(path_separator ":")
          if ("${{ runner.os }}" STREQUAL "Windows")
            set(path_separator ";")
          endif()
          set(ENV{PATH} "$ENV{GITHUB_WORKSPACE}${path_separator}$ENV{PATH}")
          execute_process(
            COMMAND ${{ steps.cmake_and_ninja.outputs.cmake_dir }}/cmake
              -S .
              -B build
              -D CMAKE_BUILD_TYPE=$ENV{BUILD_TYPE}
              -D CMAKE_C_COMPILER_LAUNCHER=ccache
              -D CMAKE_CXX_COMPILER_LAUNCHER=ccache
            RESULT_VARIABLE result
          )
          if (NOT result EQUAL 0)
            message(FATAL_ERROR "Bad exit status")
          endif()


      - name: Install Qt
        uses: jurplel/install-qt-action@v2
        with:
          version: '5.15.2'
          host: 'windows'
          modules: 'qtnetworkauth qtcharts'
          target: "desktop"
          arch: win64_msvc2019_64
          dir: "${{github.workspace}}/qt/"
          install-deps: "true"

      - name: Build
        run: |
            qmake
            cd src
            echo "#define STRAVA_SECRET_KEY ${{ secrets.strava_secret_key }}" > secret.h
            echo "#define SMTP_USERNAME ${{ secrets.smtp_username }}" >> secret.h
            echo "#define SMTP_PASSWORD ${{ secrets.smtp_password }}" >> secret.h
            echo "#define SMTP_SERVER ${{ secrets.smtp_server }}" >> secret.h
            cd ..
            make -j8
            cd src/debug
            mkdir output
            mkdir appx
            cp qdomyos-zwift.exe output/
            cd output
            windeployqt --qmldir ../../ qdomyos-zwift.exe
            cp ../../../icons/iOS/iTunesArtwork@2x.png .
            cp ../../AppxManifest.xml .
            mkdir adb
            cp ../../adb/* adb/
            cd ..
            cd appx
            #../../MSIX-Toolkit/WindowsSDK/10/10.0.20348.0/x64/makeappx.exe pack /d ../output/ /p qz

      - name: Archive windows binary
        uses: actions/upload-artifact@v2
        with:
          name: windows-binary
          path: src/debug/output

#  window-steam-build:
#    runs-on: windows-latest
#
#    steps:
#      - uses: actions/checkout@v2
#      - name: Checkout submodule repo
#        uses: actions/checkout@v2
#        with:
#          repository: bluetiger9/SmtpClient-for-Qt
#          path: "src/smtpclient/"
#          ref: 3fa4a0fe5797070339422cf18b5e9ed8dcb91f9c
#
#      - uses: actions/checkout@v2
#      - name: Checkout submodule repo
#        uses: actions/checkout@v2
#        with:
#          repository: cagnulein/qmdnsengine
#          path: "src/qmdnsengine/"
#          ref: "zwift"
#
#      - uses: msys2/setup-msys2@v2
#        with:
#          install: mingw-w64-x86_64-toolchain
#          msystem: mingw64
#          release: false
#
#      - name: Setup cmake
#        uses: jwlawson/actions-setup-cmake@v1.9
#        with:
#          cmake-version: '3.20.x'
#
#      - name: Install Qt
#        uses: jurplel/install-qt-action@v2
#        with:
#          version: '5.15.2'
#          host: 'windows'
#          modules: 'qtnetworkauth qtcharts'
#          target: "desktop"
#          arch: win64_mingw81
#          dir: "${{github.workspace}}/qt/"
#          install-deps: "true"
#
#      - name: Build
#        run: |
#            qmake
#            cd src
#            echo "#define STRAVA_SECRET_KEY ${{ secrets.strava_secret_key }}" > secret.h
#            echo "#define SMTP_USERNAME ${{ secrets.smtp_username }}" >> secret.h
#            echo "#define SMTP_PASSWORD ${{ secrets.smtp_password }}" >> secret.h
#            echo "#define SMTP_SERVER ${{ secrets.smtp_server }}" >> secret.h
#            echo "#define STEAM_STORE" >> secret.h
#            cd ..
#            make -j8
#            cd src/debug
#            mkdir output
#            mkdir appx
#            cp qdomyos-zwift.exe output/
#            cd output
#            windeployqt --qmldir ../../ qdomyos-zwift.exe
#            cp "${{github.workspace}}/qt/Qt/5.15.2/mingw81_64/bin/libwinpthread-1.dll" .
#            cp "${{github.workspace}}/qt/Qt/5.15.2/mingw81_64/bin/libgcc_s_seh-1.dll" .
#            cp "${{github.workspace}}/qt/Qt/5.15.2/mingw81_64/bin/libstdc++-6.dll" .
#
#      - uses: game-ci/steam-deploy@v1
#        with:
#          username: ${{ secrets.STEAM_USERNAME }}
#          password: ${{ secrets.STEAM_PASSWORD }}
#          configVdf: ${{ secrets.STEAM_CONFIG_VDF}}
#          ssfnFileName: ${{ secrets.STEAM_SSFN_FILE_NAME }}
#          ssfnFileContents: ${{ secrets.STEAM_SSFN_FILE_CONTENTS }}
#          appId: 2267200
#          buildDescription: 2.12
#          rootPath: src/debug/output
#          depot1Path: ./
#          #depot2Path: StandaloneLinux64
#          releaseBranch: prerelease
